#!/bin/bash

# ====================================================
# Docker Compose (rootless install for DOM Cloud)
# Works on ARM64 or x86_64 — No sudo, no apt
# ====================================================

COMPOSE_VERSION="2.27.0"

# Detect architecture
ARCH=$(uname -m)
if [ "$ARCH" = "x86_64" ]; then
    BINARY_URL="https://github.com/docker/compose/releases/download/v${COMPOSE_VERSION}/docker-compose-linux-x86_64"
elif [ "$ARCH" = "aarch64" ]; then
    BINARY_URL="https://github.com/docker/compose/releases/download/v${COMPOSE_VERSION}/docker-compose-linux-aarch64"
else
    echo "❌ Unsupported architecture: $ARCH"
    exit 1
fi

# Create bin folder
mkdir -p $HOME/bin

# Download correct binary
echo "⬇️ Downloading Docker Compose v${COMPOSE_VERSION} for $ARCH ..."
curl -L "$BINARY_URL" -o $HOME/bin/docker-compose

# Make executable
chmod +x $HOME/bin/docker-compose

# Add to PATH if not added yet
if ! echo "$PATH" | grep -q "$HOME/bin"; then
  echo 'export PATH=$HOME/bin:$PATH' >> ~/.bashrc
  export PATH=$HOME/bin:$PATH
fi

# Test
echo
echo "✅ Docker Compose installed successfully!"
$HOME/bin/docker-compose version || echo "⚠️ Run 'source ~/.bashrc' and try again."
